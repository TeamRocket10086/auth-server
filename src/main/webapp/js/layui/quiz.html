<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Quiz</title>
    <script src="js/jquery.min.js"></script>
    <script src="js/layui/layui.js"></script>
    <link rel="stylesheet" href="js/layui/css/layui.css">
    <style>
        #q-main {
            width: 800px;
            height: 600px;
        }

        #q-main>div>div {
            position: relative;
        }

        #q-header {
            clear: both;
            width: 100%;
            height: 20%;
        }

        #q-header>.q-left {
            background-color: cornflowerblue;
        }

        #q-header>.q-right {
            background-color: #e2ed64;
        }

        #q-body {
            clear: both;
            width: 100%;
            height: 80%;
        }

        #q-body>.q-left {
            background-color: #e2ed64;
        }

        #q-body>.q-right {
            background-color: cornflowerblue;
        }

        .q-left {
            height: 100%;
            width: 65%;
            float: left;
        }

        .q-right {
            height: 100%;
            width: 35%;
            float: left;
        }

        #q-header>.q-left>p,
        #q-header>.q-right>p {
            height: 50px;
            width: 100%;
            line-height: 32px;
            font-size: 32px;
            text-align: left;
            position: absolute;
            bottom: 0;
            left: 30px;
        }

        #q-body>.q-left>.layui-form {
            padding-top: 50px;
        }

        #q-body>.q-left>.layui-form>.layui-form-item {
            height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .q-sel {
            height: 50px;
            margin-left: 100px;
        }

        .q-sel>.layui-input-block {
            margin-left: 0;
        }

        .q-sel .layui-form-radio>* {
            height: 50px;
            font-size: 30px;
            float: left;
        }

        .q-sel .layui-form-radio {
            width: 100%;
        }

        .q-sel .layui-form-radio>div {
            height: 60px;
            word-break: break-all;
            width: 80%;
            font-size: 30px;
            float: left;
        }

        .q-btn {
            position: absolute;
            bottom: 0;
            width: 100%;
            margin-bottom: 0;
        }

        .q-btn>.layui-input-block {
            margin-left: 20px;
            margin-right: 20px;
        }

        .q-btn>.layui-input-block>.layui-btn {
            width: 100px;
        }

        .q-btn>.layui-input-block>.layui-btn:first-child {
            float: left;
        }

        .q-btn>.layui-input-block>.layui-btn:last-child {
            float: right;
        }

        .q-qlist {
            width: 150px;
            height: 300px;
            overflow-x: hidden;
            overflow-y: auto;
            margin: 20px auto;
        }

        .q-qlist>a {
            width: 60px;
            height: 60px;
            line-height: 60px;
            text-align: center;
            display: inline-block;
            cursor: pointer;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
            transition: background-color .5s;
        }

        .q-qlist>a:hover {
            transition: background-color .5s;
        }

        .q-btn-submit-div {
            position: absolute;
            bottom: 0;
            height: 60px;
            width: 100%;
        }

        .q-btn-submit-div>a {
            width: 100px;
            display: block;
            margin: 0 auto;
        }

    </style>
</head>

<body>
    <div id="q-main">
        <div id="q-header">
            <div class="q-left">
                <p>Q</p>
            </div>
            <div class="q-right">
                <p>Timer:&nbsp;<span></span>&nbsp;s</p>
            </div>
        </div>
        <div id="q-body">
            <div class="q-left">
                <form class="layui-form" action="">
                    <div class="layui-form-item q-btn">
                        <div class="layui-input-block">
                            <a class="layui-btn layui-btn-normal" id="q-btn-pre">Previous</a>
                            <a class="layui-btn layui-btn-normal" id="q-btn-next">Next</a>
                        </div>
                    </div>
                </form>
            </div>
            <div class="q-right">
                <div class="q-qlist">
                </div>
                <div class='q-btn-submit-div'>
                    <a class="layui-btn" id="q-btn-submit">Submit</a>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" defer>
        var jsonText = '[{"qId": 1, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 7, "qText": "What is Java7?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level7"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 10, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 5, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 3, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 2, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 8, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 9, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 6, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]},{"qId": 4, "qText": "What is Java?", "qTag": "java", "qSel": [{"sId": 1, "sText": "low-level"}, {"sId": 2, "sText": "mid-level"}, {"sId": 3, "sText": "high-level"}, {"sId": 4, "sText": "platform-dependent"}]}]';
        var json = JSON.parse(jsonText);
        var qIndex = 0;
        var userAnwser = {};
        var animateFlag1 = false;
        var animateFlag2 = false;
        var not = 0;
        var timer = 360;

        $(document).ready(function() {
            layui.use(['layer', 'form'], function() {
                $.each(json, function(i$, o$) {
                    $('.q-qlist').append('<a qId="' + o$['qId'] + '">' + (i$ + 1) + '</a>');
                });

                function displayQuestionByIndex() {
                    if (animateFlag1 || animateFlag2) {
                        return false;
                    }
                    var question = json[qIndex];
                    var answer = 0;
                    if (!!userAnwser[question['qId']]) {
                        answer = userAnwser[question['qId']];
                    }
                    animateFlag1 = true;
                    animateFlag2 = true;
                    if ($('#q-header>.q-left>p>span').length !== 0) {
                        $('#q-header>.q-left>p>span').fadeOut('fast', 'swing', function() {
                            $('#q-header>.q-left>p>span').remove();
                            $('#q-header>.q-left>p').append('<span>' + (qIndex + 1) + ': ' + question['qText'] + '</span>');
                            $('#q-header>.q-left>p>span').hide().fadeIn('fast', 'swing', function() {
                                animateFlag1 = false;
                            });
                        });
                    } else {
                        $('#q-header>.q-left>p').append('<span>' + (qIndex + 1) + ': ' + question['qText'] + '</span>');
                        $('#q-header>.q-left>p>span').hide().fadeIn('fast', 'swing', function() {
                            animateFlag1 = false;
                        });
                    }
                    var qSel = question['qSel'];
                    if (!!!qSel) {
                        qSel = [];
                    }
                    if (!$.isArray(qSel)) {
                        qSel = [qSel];
                    }
                    if ($('#q-body>.q-left>.layui-form>.q-sel').length !== 0) {
                        $('#q-body>.q-left>.layui-form>.q-sel').fadeOut('fast', 'swing', function() {
                            $('#q-body>.q-left>.layui-form>.q-sel').remove();
                            $.each(qSel, function(i$, o$) {
                                var $sel = $('<div class="layui-form-item q-sel"><div class="layui-input-block"><input type="radio" name="ANWSER" value="' + o$['sId'] + '" title="' + o$['sText'] + '"></div></div>');
                                $('#q-body>.q-left>.layui-form>.q-btn').before($sel);
                            });
                            layui.form.render();
                            $('#q-body>.q-left>.layui-form>.q-sel').hide().fadeIn('fast', 'swing', function() {
                                animateFlag2 = false;
                                $('#q-body>.q-left>.layui-form>.q-sel>.layui-input-block>input[value=' + answer + ']').attr('checked', '');
                                layui.form.render();
                            });
                        });
                    } else {
                        $.each(qSel, function(i$, o$) {
                            var $sel = $('<div class="layui-form-item q-sel"><div class="layui-input-block"><input type="radio" name="ANWSER" value="' + o$['sId'] + '" title="' + o$['sText'] + '"></div></div>');
                            $('#q-body>.q-left>.layui-form>.q-btn').before($sel);
                        });
                        layui.form.render();
                        $('#q-body>.q-left>.layui-form>.q-sel').hide().fadeIn('fast', 'swing', function() {
                            animateFlag2 = false;
                            $('#q-body>.q-left>.layui-form>.q-sel>.layui-input-block>input[value=' + answer + ']').attr('checked', '');
                            layui.form.render();
                        });
                    }
                    $($('.q-qlist>a')[qIndex]).hover();
                    return true;
                }
                updateQList();
                displayQuestionByIndex();
                setTimer();

                function recordAnswer() {
                    var a = $('input[name=ANWSER]:checked').val();
                    if (!!a) {
                        userAnwser[json[qIndex]['qId'] + ''] = a;
                    }
                }

                function updateQList() {
                    if (animateFlag1 || animateFlag2) {
                        return;
                    }
                    not = 0;
                    $.each(json, function(i$, o$) {
                        if (!!!userAnwser[o$['qId']]) {
                            not++;
                            $('.q-qlist>a[qId=' + o$['qId'] + ']').css('background-color', '#cccccc');
                        } else {
                            $('.q-qlist>a[qId=' + o$['qId'] + ']').css('background-color', '#a9ffa9');
                        }
                    });
                    $($('.q-qlist>a')[qIndex]).css('background-color', '#9fffff');
                }
                
                function submit$() {
                    recordAnswer();
                    updateQList();
                    if (not !== 0) {
                        layui.layer.confirm(not + ' questions not complete, sure to submit?', {
                            title: 'Confirm',
                            btn: ['yes', 'not yet'],
                            yes: function() {
                                submit();
                            }
                        });
                    }
                }
                
                function submit(flag) {
                    if (!!flag) {
                        recordAnswer();
                        updateQList();
                    }
                    layui.layer.closeAll();
                    console.log(userAnwser);
                    // submit anwsers to servlet.
                    // TODO
                }
                
                function setTimer() {
                    if (timer <= 0) {
                        submit();
                    }
                    else {
                        timer --;
                        $('#q-header>.q-right>p>span').text(timer);
                    }
                    setTimeout(setTimer, 1000);
                }

                $('#q-body').bind('change', function(e) {
                    console.log(e);
                });
                $('#q-btn-pre').bind('click', function(e) {
                    if (animateFlag1 || animateFlag2) {
                        return;
                    }
                    if (qIndex <= 0) {
                        e.preventDefault();
                        return;
                    } else {
                        recordAnswer();
                        qIndex--;
                        updateQList();
                        displayQuestionByIndex();
                    }
                });
                $('#q-btn-next').bind('click', function(e) {
                    if (animateFlag1 || animateFlag2) {
                        return;
                    }
                    if (qIndex >= (json.length - 1)) {
                        e.preventDefault();
                        return;
                    } else {
                        recordAnswer();
                        qIndex++;
                        updateQList();
                        displayQuestionByIndex();
                    }
                });
                $('.q-qlist').bind('click', function(e) {
                    if (animateFlag1 || animateFlag2) {
                        return;
                    }
                    var index = parseInt($(e.target).attr('qId'));
                    $.each(json, function(i$, o$) {
                        if (index === o$['qId'] && i$ !== qIndex) {
                            recordAnswer();
                            qIndex = i$;
                            updateQList();
                            if (displayQuestionByIndex()) {
                                qIndex = i$;
                            }
                            return false;
                        }
                    });
                });
                $('#q-btn-submit').bind('click', function() {
                    submit$();
                });
            });

        });

    </script>
</body>

</html>
